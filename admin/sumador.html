<!doctype html>
<html lang="es-AR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Juego 1: Sumador</title>
  <style>
    body{
      font-family:system-ui,Arial;
      margin:18px;
      max-width:800px;
      overscroll-behavior:none;
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
      touch-action:manipulation;
    }
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    .muted{opacity:.75}
    .timer{font-size:40px;font-weight:700;margin:8px 0}
    .score{font-size:30px;font-weight:700;margin:8px 0}
    #playBtn{
      width:100%;
      max-width:520px;
      height:260px;
      font-size:220px;
      line-height:1;
      font-weight:800;
      border-radius:20px;
      border:2px solid #233;
      color:#fff;
      cursor:pointer;
      touch-action:manipulation;
      -webkit-user-select:none;
      user-select:none;
    }
    #playBtn.plus{background:#1f9d49}
    #playBtn.minus{background:#d0312d}
    #startBtn{padding:10px 16px}
    .danger{color:#9b1c1c}
    .mode-toggle{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 4px}
    .mode-btn{padding:8px 12px;border:1px solid #666;background:#fff;border-radius:8px;cursor:pointer}
    .mode-btn.active{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
    .mode-hint{margin:6px 0 0}
  </style>
</head>
<body>
  <h1>Juego 1: Sumador</h1>

  <div class="card">
    <h3>Acceso</h3>
    <p>Jugador: <strong id="playerName">—</strong></p>
    <p>Estado: <strong id="playerStatus">Cargando...</strong></p>
  </div>

  <div class="card">
    <p>Duración total: <strong>20 segundos</strong>.</p>
    <p>Un botón gigante alterna entre <strong>+</strong> y <strong>-</strong> en intervalos aleatorios (0.0 a 1.0s).</p>
    <ul>
      <li><strong>+</strong> suma 2 puntos.</li>
      <li><strong>-</strong> resta 1 punto.</li>
      <li>Podés hacer clicks ilimitados, pero si tocás mucho el <strong>-</strong>, vas a perder muchos puntos.</li>
    </ul>
    <div class="mode-toggle">
      <button id="modePracticeBtn" class="mode-btn" type="button">Modo Prueba (∞)</button>
      <button id="modeRealBtn" class="mode-btn" type="button">Modo Real (1 vez)</button>
    </div>
    <p id="modeHint" class="mode-hint muted">Esto es práctica: no suma puntos al ranking.</p>
    <button id="startBtn">Comenzar</button>
    <span id="status" class="muted"></span>
  </div>

  <div class="card">
    <div>Cuenta regresiva</div>
    <div id="timer" class="timer">20.0</div>
    <div>Puntaje</div>
    <div id="score" class="score">0</div>
    <div>Clicks: <span id="clicks">0</span></div>
  </div>

  <button id="playBtn" class="plus" disabled>+</button>

  <script src="player_context.js"></script>
  <script>
    const API = 'api.php';
    const WELCOME_PAGE = '../index.html';
    const TOTAL_MS = 20000;
    const MODE_STORAGE_KEY = 'sumador_mode';
    const GAME_CODE = 'sumador';

    const startBtn = document.getElementById('startBtn');
    const playBtn = document.getElementById('playBtn');
    const timerEl = document.getElementById('timer');
    const scoreEl = document.getElementById('score');
    const clicksEl = document.getElementById('clicks');
    const statusEl = document.getElementById('status');
    const playerNameEl = document.getElementById('playerName');
    const playerStatusEl = document.getElementById('playerStatus');
    const modePracticeBtn = document.getElementById('modePracticeBtn');
    const modeRealBtn = document.getElementById('modeRealBtn');
    const modeHintEl = document.getElementById('modeHint');

    // Bloqueamos gestos que suelen romper la ráfaga de taps en iOS/Android
    // (doble tap zoom / selección accidental), sin depender de librerías externas.
    document.addEventListener('dblclick', (event) => event.preventDefault(), { passive: false });
    document.addEventListener('gesturestart', (event) => event.preventDefault(), { passive: false });

    let score = 0;
    let clicks = 0;
    let running = false;
    let gameStartMs = 0;
    let countdownTimer = null;
    let symbolTimer = null;
    let playerAvailable = false;
    let sumadorPlayedReal = false;
    let activePlayerId = 0;
    let activePlayerToken = '';
    let gameMode = localStorage.getItem(MODE_STORAGE_KEY) === 'real' ? 'real' : 'practice';

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    async function call(action, body) {
      const res = await fetch(`${API}?action=${encodeURIComponent(action)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {}),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        throw new Error(data.error || `HTTP ${res.status}`);
      }
      return data;
    }

    function authPayload() {
      if (activePlayerToken) {
        return { player_token: activePlayerToken };
      }
      return { player_id: activePlayerId };
    }

    function applyModeUI() {
      modePracticeBtn.classList.toggle('active', gameMode === 'practice');
      modeRealBtn.classList.toggle('active', gameMode === 'real');

      if (gameMode === 'practice') {
        modeHintEl.textContent = 'Esto es práctica: no suma puntos al ranking.';
      } else {
        modeHintEl.textContent = 'Esto suma para el ranking y es una sola vez.';
      }

      updateAvailabilityStatus();
    }

    function setGameMode(mode) {
      gameMode = mode === 'real' ? 'real' : 'practice';
      localStorage.setItem(MODE_STORAGE_KEY, gameMode);
      applyModeUI();
    }

    function updateAvailabilityStatus() {
      playerAvailable = gameMode === 'practice' ? true : !sumadorPlayedReal;
      startBtn.disabled = !playerAvailable || running;

      if (sumadorPlayedReal) {
        playerStatusEl.textContent = 'Ya jugaste en modo real';
      } else {
        playerStatusEl.textContent = 'Disponible';
      }

      if (gameMode === 'real' && sumadorPlayedReal) {
        setStatus('Ya jugaste en modo real. Podés cambiar a práctica y jugar igual.');
      } else if (!running) {
        setStatus('Listo para jugar.');
      }
    }

    async function ensurePlayer() {
      try {
        const player = await window.PlayerContext.ensureActivePlayerForThisDevice();
        activePlayerId = Number(player.id || localStorage.getItem('player_id') || 0);
        activePlayerToken = String(player.player_token || localStorage.getItem('player_token') || '');
      } catch (err) {
        setStatus(err.message || 'No hay jugador activo.');
        location.href = WELCOME_PAGE;
      }
    }

    async function fetchPlayerInfo() {
      if (activePlayerId <= 0 && !activePlayerToken) {
        location.href = WELCOME_PAGE;
        return;
      }

      try {
        const data = await call('player_info', {
          ...authPayload(),
        });

        playerNameEl.textContent = data.display_name || 'Sin nombre';
        sumadorPlayedReal = Boolean(data.sumador_played_real ?? data.sumador_played);
        updateAvailabilityStatus();
      } catch (err) {
        playerNameEl.textContent = 'No identificado';
        playerStatusEl.textContent = 'No disponible';
        setStatus(`No se pudo resolver el jugador: ${err.message}`);
        startBtn.disabled = true;
      }
    }

    function nextSymbol() {
      if (!running) return;
      const symbol = Math.random() < 0.5 ? '+' : '-';
      playBtn.textContent = symbol;
      playBtn.classList.toggle('plus', symbol === '+');
      playBtn.classList.toggle('minus', symbol === '-');
      const nextMs = Math.floor(Math.random() * 1000);
      symbolTimer = setTimeout(nextSymbol, nextMs);
    }

    function render() {
      scoreEl.textContent = String(score);
      clicksEl.textContent = String(clicks);
    }

    function stopTimers() {
      if (countdownTimer) clearInterval(countdownTimer);
      if (symbolTimer) clearTimeout(symbolTimer);
      countdownTimer = null;
      symbolTimer = null;
    }

    async function finishGame() {
      running = false;
      stopTimers();
      playBtn.disabled = true;
      const realDurationMs = Math.round(performance.now() - gameStartMs);
      timerEl.textContent = '0.0';

      try {
        await call('sumador_finish', {
          ...authPayload(),
          mode: gameMode,
          score,
          clicks,
          duration_ms: realDurationMs,
        });
        if (gameMode === 'practice') {
          setStatus(`Práctica finalizada. Tu puntaje fue ${score} (no suma al ranking).`);
        } else {
          setStatus(`Juego finalizado. Puntaje final: ${score}. Resultado real registrado.`);
          sumadorPlayedReal = true;
        }
        updateAvailabilityStatus();
      } catch (err) {
        setStatus(`Error al guardar: ${err.message}`);
      }
    }

    function startLoop() {
      gameStartMs = performance.now();
      running = true;
      playBtn.disabled = false;
      nextSymbol();

      countdownTimer = setInterval(() => {
        const elapsed = performance.now() - gameStartMs;
        const remaining = Math.max(0, TOTAL_MS - elapsed);
        timerEl.textContent = (remaining / 1000).toFixed(1);
        if (remaining <= 0) {
          finishGame();
        }
      }, 50);
    }

    // En móviles usamos pointerdown para reducir latencia y evitar problemas de doble tap/click.
    // preventDefault ayuda a suprimir selección/gestos no deseados durante taps rápidos.
    playBtn.addEventListener('pointerdown', (event) => {
      event.preventDefault();
      if (!running) return;
      clicks += 1;
      score += (playBtn.textContent === '+') ? 2 : -1;
      render();
    });

    startBtn.addEventListener('click', async () => {
      if (!playerAvailable) {
        setStatus('Jugador no disponible para jugar.');
        return;
      }

      if (activePlayerId <= 0 && !activePlayerToken) {
        location.href = WELCOME_PAGE;
        return;
      }

      startBtn.disabled = true;
      setStatus('Iniciando...');

      try {
        await call(`${GAME_CODE}_start`, {
          ...authPayload(),
          mode: gameMode,
        });
      } catch (err) {
        if (String(err.message).includes('Ya jugaste este juego (modo real).')) {
          sumadorPlayedReal = true;
          updateAvailabilityStatus();
        } else {
          setStatus(`No se pudo iniciar: ${err.message}`);
        }
        startBtn.disabled = !playerAvailable;
        return;
      }

      score = 0;
      clicks = 0;
      timerEl.textContent = '20.0';
      playBtn.classList.remove('plus', 'minus');
      render();
      setStatus('¡Jugando!');
      startLoop();
    });

    modePracticeBtn.addEventListener('click', () => setGameMode('practice'));
    modeRealBtn.addEventListener('click', () => setGameMode('real'));

    startBtn.disabled = true;
    (async function init() {
      applyModeUI();
      await ensurePlayer();
      await fetchPlayerInfo();
    })();
  </script>
</body>
</html>
